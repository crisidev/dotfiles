#!/usr/bin/zsh

# set -x
set -e -o pipefail

# nvim listen socket
NVIM_LISTEN_ADDRESS=/tmp/nvimsocket

# Functions
usage() {
	echo "usage: $0 toggle|new|<filenames..>"
	exit 2
}

# Start neovim IDE using class `ide` and listening on $NVIM_LISTEN_ADDRESS
function start_ide() {
    [ -f $HOME/.zsh_env ] && source $HOME/.zsh_env
    [ -f $HOME/.zsh_secrets ] && source $HOME/.zsh_secrets
    export LUNARVIM_RUNTIME_DIR="${LUNARVIM_RUNTIME_DIR:-"/home/ANT.AMAZON.COM/matbigoi/.local/share/lunarvim"}"
    export LUNARVIM_CONFIG_DIR="${LUNARVIM_CONFIG_DIR:-"/home/ANT.AMAZON.COM/matbigoi/.config/lvim"}"
    export LUNARVIM_CACHE_DIR="${LUNARVIM_CACHE_DIR:-"/home/ANT.AMAZON.COM/matbigoi/.cache/lvim"}"
    export LUNARVIM_BASE_DIR="${LUNARVIM_BASE_DIR:-"/home/ANT.AMAZON.COM/matbigoi/.local/share/lunarvim/lvim"}"
    # exec /home/ANT.AMAZON.COM/matbigoi/github/gnvim/target/release/gnvim -- -u "$LUNARVIM_BASE_DIR/init.lua" "$@"
	exec kitty --detach --config "$HOME/.config/kitty/ide.conf" --class ide "$HOME/.bin/vim" --listen $NVIM_LISTEN_ADDRESS --cmd "let g:crisidev_ide=1" "$@"
    # neovide --x11-wm-class ide -- -u "$LUNARVIM_RUNTIME_DIR/lvim/init.lua"  --listen $NVIM_LISTEN_ADDRESS --cmd "let g:crisidev_ide=1" "$@"
    # exec ~/github/fvim/bin/Release/net6.0/linux-x64/FVim -u "$LUNARVIM_BASE_DIR/init.lua"  "$@"
}

# Open a file inside the running IDE.
function open_in_ide() {
	if ! pgrep -f "\-class ide"; then
		start_ide
		sleep 0.5
	fi
	exec nvr --remote "$@"
}

# Toggle the IDE window.
function toggle_ide() {
	if ! pgrep -f "\-class ide"; then
		start_ide
		sleep 0.5
	fi
	i3-msg '[class="ide"] focus'
}

# main switch
case $1 in
*help*)
	usage
	;;
toggle)
	toggle_ide
	;;
new)
	export_env
	shift
	start_ide "$@"
	;;
*)
	open_in_ide "$@"
	;;
esac

exit 0
