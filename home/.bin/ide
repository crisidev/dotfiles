#!/usr/bin/env bash

# set -x
set -e -o pipefail

# Functions
usage() {
    echo "usage: $0 toggle|new|<filenames..>"
    exit 2
}

# Nvim listen socket
NVIM_LISTEN_ADDRESS=/tmp/nvimsocket
# Paths
MY_PATH="$HOME/.bin:$HOME/.local/share/lvim/mason/bin"
BREW_PATH="/opt/homebrew/bin:/opt/homebrew/opt/gnu-sed/libexec/gnubin:/opt/homebrew/opt/coreutils/libexec/gnubin:/opt/homebrew/opt/grep/libexec/gnubin:/opt/homebrew/opt/ssh-copy-id/bin"
SYSTEM_PATH="/usr/local/bin"
export PATH="$MY_PATH:$BREW_PATH:$SYSTEM_PATH:$PATH"
# Rtx
eval "$(rtx activate bash)"

# Start neovim IDE using class `ide` and listening on $NVIM_LISTEN_ADDRESS
function start_ide() {
    [ -f "$HOME/.zsh_secrets" ] && source "$HOME/.zsh_secrets"

    export NVIM_APPNAME="${NVIM_APPNAME:-"lvim"}"
    export LUNARVIM_RUNTIME_DIR="${LUNARVIM_RUNTIME_DIR:-"$HOME/.local/share/lunarvim"}"
    export LUNARVIM_CONFIG_DIR="${LUNARVIM_CONFIG_DIR:-"$HOME/.config/lvim"}"
    export LUNARVIM_CACHE_DIR="${LUNARVIM_CACHE_DIR:-"$HOME/.cache/lvim"}"
    export LUNARVIM_BASE_DIR="${LUNARVIM_BASE_DIR:-"$HOME/.local/share/lunarvim/lvim"}"

    # exec /home/ANT.AMAZON.COM/matbigoi/github/gnvim/target/release/gnvim -- -u "$LUNARVIM_BASE_DIR/init.lua" "$@"
    exec -a "$NVIM_APPNAME" /opt/homebrew/bin/neovide --multigrid --notabs --neovim-bin "$(rtx which nvim)" -- -u "$LUNARVIM_BASE_DIR/init.lua" --listen "$NVIM_LISTEN_ADDRESS" "$@"
    # neovide --x11-wm-class ide -- -u "$LUNARVIM_RUNTIME_DIR/lvim/init.lua"  --listen $NVIM_LISTEN_ADDRESS --cmd "let g:crisidev_ide=1" "$@"
    # exec ~/github/fvim/bin/Release/net6.0/linux-x64/FVim -u "$LUNARVIM_BASE_DIR/init.lua"  "$@"
}

# Open a file inside the running IDE.
function open_in_ide() {
    if ! pgrep -f "/opt/homebrew/bin/neovide" >/dev/null; then
        start_ide
        sleep 0.5
    fi
    exec nvr --remote "$@"
}

# main switch
case $1 in
    *help*)
        usage
        ;;
    new)
        shift
        start_ide "$@"
        ;;
    *)
        open_in_ide "$@"
        ;;
esac

exit 0
