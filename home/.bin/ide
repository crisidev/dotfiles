#!/usr/bin/env bash

usage() {
	echo "usage: $0 [toggle]"
	exit 2
}

set -x

# paths
source ~/.zsh_secrets
export GOPATH=~/.go
export PATH=~/.bin:~/.toolbox/bin:~/.pyenv/bin:~/.rbenv/bin:~/.nodenv/bin:~/.goenv/bin:~/.bin:~/.cargo/bin:~/.android/Sdk/platform-tools:~/.toolchain/aarch64-linux-musl/bin:~/.nodenv/shims:~/.pyenv/shims:~/.rbenv/shims:~/.goenv/shims:$PATH
export LUNARVIM_CONFIG_DIR="${LUNARVIM_CONFIG_DIR:-$HOME/.config/lvim}"
export LUNARVIM_RUNTIME_DIR="${LUNARVIM_RUNTIME_DIR:-$HOME/.local/share/lunarvim}"

# rbenv
export RBENV_ROOT="$HOME/.rbenv"
if which rbenv > /dev/null; then eval "$(rbenv init -)"; fi

# direnv
if which direnv > /dev/null; then eval "$(direnv hook zsh)"; fi

# pyenv
export PYENV_ROOT="$HOME/.pyenv"
if which pyenv > /dev/null; then 
  eval "$(pyenv init --path)"
  eval "$(pyenv virtualenv-init -)"
  source $HOME/.pyenv/completions/pyenv.zsh
  export PYENV_VIRTUALENV_DISABLE_PROMPT=1
fi

# nodenv
export NODENV_ROOT="$HOME/.nodenv"
if which nodenv > /dev/null; then 
  eval "$(nodenv init -)"
  export PATH=$PATH:~/.nodenv/versions/17.0.1/bin
fi

# nodenv
export GOENV_ROOT="$HOME/.goenv"
if which goenv > /dev/null; then 
  export GOENV_GOPATH_PREFIX=$HOME/.go
  eval "$(goenv init -)" 
  export PATH=$PATH:$GOPATH/bin
fi

# sdkman
source "$HOME/.sdkman/bin/sdkman-init.sh"

start_ide() {
	NVIM_LISTEN_ADDRESS=/tmp/nvimsocket kitty --detach --config ~/.config/kitty/glrnvim.conf --class ide ~/.local/bin/lvim
}

start_lvim() {
	NVIM_LISTEN_ADDRESS=/tmp/nvimsocket lvim "$@"
}

if [ "$1" = "--help" ]; then
	usage
elif [ "$1" = "toggle" ]; then
    if ! pgrep -f "\-\-class ide"; then
        start_ide
    fi
    i3-msg '[class="ide"] focus'
elif [ "$1" = "new" ]; then
	start_ide
elif [ "$1" = "term" ]; then
	start_lvim "$@"
else
	nvr --remote "$@"
fi

exit 0
