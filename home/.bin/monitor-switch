#!/usr/bin/env bash
export PATH=$PATH:/usr/bin:$HOME/.bin


# If the argument "now" is provided, set override to true.
override=0
if [ "$1" == "now" ]; then
    override=1
fi

# Initialize a variable to keep track of the last detected configuration.
prev=""

while true; do
    # Loop through available EDID files and decode them.
    # The output is filtered for "Display Product Name" lines.
    monitor_info=$(for edid in /sys/class/drm/*/edid; do
        edid-decode "$edid" 2>/dev/null | grep "Display Product Name"
    done)

    # Determine the current monitor configuration and the associated text scaling factor.
    if echo "$monitor_info" | grep -q "BenQ PD3200U"; then
        current="home"
        scale="1.00"
        kitty_font="11"
    else
        current="builtin"
        scale="1.3"
        kitty_font="13"
    fi

    # If "now" override is active or the configuration changed, update the scaling.
    if [ "$override" -eq 1 ] || [ "$current" != "$prev" ]; then
        echo "Detected ${current} monitor, setting text scaling to ${scale}"
        gsettings set org.gnome.desktop.interface text-scaling-factor "$scale"
        sed -i "s/^font_size .*/font_size ${kitty_font}/" ~/.config/kitty/font_size.conf
        kill -SIGUSR1 $(pidof kitty)
        # Update previous state after the change.
        focus-switch rebalance
        prev="$current"
        if [ "$override" -eq 1 ]; then
            exit 0
        fi
    else
        echo "Detected same ${current} monitor, not changing the text scaling"
    fi

    sleep 10
done
